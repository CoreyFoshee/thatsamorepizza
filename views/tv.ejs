<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title><%= title %></title>
    <meta name="description" content="<%= description %>">
    <meta name="robots" content="noindex, nofollow">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Supabase Client for Real-time Updates -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        // Expose Supabase credentials to frontend (anon key is safe for public use)
        window.supabaseUrl = '<%= typeof supabaseUrl !== "undefined" ? supabaseUrl : "" %>';
        window.supabaseAnonKey = '<%= typeof supabaseAnonKey !== "undefined" ? supabaseAnonKey : "" %>';
        // Store reference to the global supabase object
        window.supabaseLib = supabase;
    </script>
    
    <!-- Custom Styles -->
    <style>
        body {
            margin: 0;
            padding: 0;
            overflow: hidden;
            background: linear-gradient(135deg, #1a1a1a 0%, #2d1b69 100%);
        }
        
        .tv-container {
            width: 100vw;
            height: 56.25vw; /* 16:9 aspect ratio (9/16 = 0.5625) */
            max-height: 100vh;
            max-width: 177.78vh; /* Maintain 16:9 when height is limiting */
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            color: white;
            font-family: 'Arial', sans-serif;
            position: relative;
            background-image: url('/images/pizza-background.png');
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            margin: 0 auto;
        }
        
        .tv-container::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.4);
            z-index: 0;
        }
        
        .voting-results {
            position: relative;
            z-index: 1;
            padding-top: 3rem;
        }
        
        .pizza-style {
            margin: 0.5rem 0;
            padding: 3rem;
            border-radius: 20px;
            background: white;
            border: 2px solid rgba(0, 0, 0, 0.1);
            color: black;
            flex: 1;
            max-height: 700px;
            max-width: 35rem;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            overflow: hidden;
        }
        
        .pizza-style h2 {
            color: black;
            font-size: 3rem;
            margin-bottom: 1.5rem;
        }
        
        .pizza-style h3 {
            font-size: 2.5rem;
            margin-bottom: 0.75rem;
        }
        
        .pizza-style .vote-count {
            color: black;
            font-size: 4.5rem;
            margin: 0.75rem 0;
            line-height: 1;
        }
        
        .pizza-style .percentage {
            color: black;
            font-size: 2.5rem;
            margin: 0.5rem 0;
            line-height: 1;
        }
        
        .pizza-style .style-section {
            margin-bottom: 2rem;
        }
        
        .pizza-style .style-section:last-child {
            margin-bottom: 0;
        }
        
        
        .qr-section {
            flex-shrink: 0;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .qr-section .bg-white {
            padding: 3rem;
        }
        
        .qr-section h3 {
            font-size: 2.5rem;
        }
        
        .qr-section p {
            font-size: 1.5rem;
        }
        
        
        .progress-bar {
            width: 100%;
            height: 65px;
            background: rgba(0, 0, 0, 0.15);
            border: 3px solid rgba(0, 0, 0, 0.2);
            border-radius: 32px;
            overflow: hidden;
            margin: 1rem 0;
            box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.1);
            flex-shrink: 0;
        }
        
        .progress-fill {
            height: 100%;
            transition: width 0.8s ease-in-out;
            border-radius: 23px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }
        
        .ny-progress {
            background: linear-gradient(90deg, #3b82f6, #1d4ed8);
        }
        
        .chicago-progress {
            background: linear-gradient(90deg, #dc2626, #991b1b);
        }
        
        .vote-count {
            font-size: 3.5rem;
            font-weight: bold;
            margin: 0.5rem 0;
            line-height: 1;
        }
        
        .percentage {
            font-size: 2rem;
            font-weight: bold;
            margin: 0.25rem 0;
            line-height: 1;
        }
        
        .total-votes {
            font-size: 1.75rem;
            margin: 1.5rem 0;
            color: #fbbf24;
            text-align: center;
        }
        
        .title {
            font-size: 4.5rem;
            font-weight: bold;
            margin-bottom: 0.25rem;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
            text-align: center;
        }
        
        .subtitle {
            font-size: 3.5rem;
            margin-bottom: 2rem;
            color: #fbbf24;
            text-align: center;
        }
        
        .live-indicator {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #ef4444;
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 25px;
            font-weight: bold;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        .last-vote {
            position: fixed;
            bottom: 20px;
            left: 20px;
            background: rgba(34, 197, 94, 0.9);
            color: white;
            padding: 1rem;
            border-radius: 10px;
            font-weight: bold;
            transform: translateX(-100%);
            transition: transform 0.5s ease-in-out;
        }
        
        .last-vote.show {
            transform: translateX(0);
        }
        
        @media (max-width: 768px) {
            .title { font-size: 2rem; }
            .vote-count { font-size: 2.5rem; }
            .percentage { font-size: 1.5rem; }
            .pizza-style { margin: 1rem 0; padding: 1rem; min-height: 300px; }
            .flex-col.lg\:flex-row { gap: 2rem; }
            .qr-section { order: -1; margin-bottom: 1rem; }
        }
    </style>
</head>
<body>
    <div class="live-indicator">ðŸ”´ LIVE</div>
    
    <div class="tv-container">
        <div class="voting-results">
            <h1 class="title">Home Of The Great Debate</h1>
            <p class="subtitle">You Decide...</p>
            
            <div class="flex flex-col lg:flex-row gap-8 items-stretch justify-center">
                <!-- Left Side: Lifetime Sales -->
                <div class="pizza-style">
                    <h2 class="text-3xl font-bold mb-6 text-center" style="color: black;">Pies Sold</h2>
                    <div class="style-section">
                        <h3 class="text-2xl font-bold mb-4" style="color: #3b82f6;">New York Style</h3>
                        <div class="vote-count" id="lifetime-sales-ny-display">0</div>
                        <div class="percentage" id="lifetime-sales-ny-percentage">0%</div>
                        <div class="progress-bar">
                            <div class="progress-fill ny-progress" id="lifetime-sales-ny-progress" style="width: 0%"></div>
                        </div>
                    </div>
                    <div class="style-section">
                        <h3 class="text-2xl font-bold mb-4" style="color: #dc2626;">Chicago Deep Dish</h3>
                        <div class="vote-count" id="lifetime-sales-chicago-display">0</div>
                        <div class="percentage" id="lifetime-sales-chicago-percentage">0%</div>
                        <div class="progress-bar">
                            <div class="progress-fill chicago-progress" id="lifetime-sales-chicago-progress" style="width: 0%"></div>
                        </div>
                    </div>
                </div>
                
                <!-- Center Section with QR Code -->
                <div class="qr-section text-center">
                    <div class="bg-white rounded-2xl p-6 shadow-lg">
                        <div class="text-6xl mb-4">ðŸ“±</div>
                        <h3 class="text-xl font-bold text-gray-800 mb-2" style="border-bottom: none; text-decoration: none;">Scan QR Code To Vote!</h3>
                        <p class="text-sm text-gray-600 mb-4">Help us settle the great debate.</p>
                        <div class="w-80 h-80 mx-auto flex items-center justify-center">
                            <img src="/images/qr-code.svg" alt="QR Code to vote" class="w-full h-full object-contain" />
                        </div>
                        <p class="text-xs text-gray-500 mt-2">thatsamorepizzaonline.com</p>
                    </div>
                </div>
                
                <!-- Right Side: Customer Vote -->
                <div class="pizza-style">
                    <h2 class="text-3xl font-bold mb-6 text-center" style="color: black;">Customer Vote</h2>
                    <div class="style-section">
                        <h3 class="text-2xl font-bold mb-4" style="color: #3b82f6;">New York Style</h3>
                        <div class="vote-count" id="ny-votes">0</div>
                        <div class="percentage" id="ny-percentage">0%</div>
                        <div class="progress-bar">
                            <div class="progress-fill ny-progress" id="ny-progress" style="width: 0%"></div>
                        </div>
                    </div>
                    <div class="style-section">
                        <h3 class="text-2xl font-bold mb-4" style="color: #dc2626;">Chicago Deep Dish</h3>
                        <div class="vote-count" id="chicago-votes">0</div>
                        <div class="percentage" id="chicago-percentage">0%</div>
                        <div class="progress-bar">
                            <div class="progress-fill chicago-progress" id="chicago-progress" style="width: 0%"></div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="total-votes">
                Total Votes: <span id="total-votes">0</span>
            </div>
        </div>
    </div>
    
    <div class="last-vote" id="last-vote">
        New vote received!
    </div>
    
    <script>
        // Initialize Supabase client
        let supabaseClient = null;
        if (window.supabaseLib && window.supabaseUrl && window.supabaseAnonKey) {
            try {
                supabaseClient = window.supabaseLib.createClient(window.supabaseUrl, window.supabaseAnonKey);
                console.log('âœ… Supabase client initialized for TV display');
            } catch (error) {
                console.error('âŒ Failed to initialize Supabase client:', error);
            }
        } else {
            console.error('âŒ Supabase credentials not available', {
                hasLib: !!window.supabaseLib,
                hasUrl: !!window.supabaseUrl,
                hasKey: !!window.supabaseAnonKey
            });
        }
        
        // DOM elements - Customer Vote (right side)
        const nyVotesEl = document.getElementById('ny-votes');
        const chicagoVotesEl = document.getElementById('chicago-votes');
        const nyPercentageEl = document.getElementById('ny-percentage');
        const chicagoPercentageEl = document.getElementById('chicago-percentage');
        const nyProgressEl = document.getElementById('ny-progress');
        const chicagoProgressEl = document.getElementById('chicago-progress');
        
        // DOM elements - Lifetime Sales (left side)
        const lifetimeSalesEl = document.getElementById('lifetime-sales');
        const lifetimeSalesChicagoEl = document.getElementById('lifetime-sales-chicago');
        const lifetimeSalesNyDisplayEl = document.getElementById('lifetime-sales-ny-display');
        const lifetimeSalesChicagoDisplayEl = document.getElementById('lifetime-sales-chicago-display');
        const lifetimeSalesNyProgressEl = document.getElementById('lifetime-sales-ny-progress');
        const lifetimeSalesChicagoProgressEl = document.getElementById('lifetime-sales-chicago-progress');
        const lifetimeSalesNyPercentageEl = document.getElementById('lifetime-sales-ny-percentage');
        const lifetimeSalesChicagoPercentageEl = document.getElementById('lifetime-sales-chicago-percentage');
        
        // Other elements
        const totalVotesEl = document.getElementById('total-votes');
        const lastVoteEl = document.getElementById('last-vote');
        
        // Load initial data from Supabase
        loadInitialData();
        
        // Load data from Supabase via API
        async function loadInitialData() {
            try {
                // Try to load from restaurant_metrics table via API
                const response = await fetch('/api/voting-data');
                const data = await response.json();
                if (data.success) {
                    console.log('Loaded initial data from Supabase:', data.data);
                    updateDisplay({
                        nyVotes: data.data.nyVotes || 0,
                        chicagoVotes: data.data.chicagoVotes || 0,
                        totalVotes: data.data.totalVotes || 0,
                        piesSold: data.data.pizzasSold || 0,
                        nyLifetimeSales: data.data.nyLifetimeSales || 0,
                        chicagoLifetimeSales: data.data.chicagoLifetimeSales || 0
                    });
                } else {
                    console.error('Failed to load data:', data);
                }
            } catch (error) {
                console.error('Error loading data from Supabase:', error);
            }
        }
        
        // Update display with voting data
        function updateDisplay(data) {
            // Update Customer Vote section (right side)
            nyVotesEl.textContent = data.nyVotes || 0;
            chicagoVotesEl.textContent = data.chicagoVotes || 0;
            totalVotesEl.textContent = data.totalVotes || 0;
            
            // Calculate vote percentages
            const nyPercentage = data.totalVotes > 0 ? Math.round((data.nyVotes / data.totalVotes) * 100) : 0;
            const chicagoPercentage = data.totalVotes > 0 ? Math.round((data.chicagoVotes / data.totalVotes) * 100) : 0;
            
            nyPercentageEl.textContent = nyPercentage + '%';
            chicagoPercentageEl.textContent = chicagoPercentage + '%';
            
            // Update vote progress bars
            nyProgressEl.style.width = nyPercentage + '%';
            chicagoProgressEl.style.width = chicagoPercentage + '%';
            
            // Update Lifetime Sales section (left side)
            const nyLifetimeSales = data.nyLifetimeSales || '';
            const chicagoLifetimeSales = data.chicagoLifetimeSales || '';
            
            if (lifetimeSalesEl) {
                lifetimeSalesEl.textContent = nyLifetimeSales;
            }
            if (lifetimeSalesChicagoEl) {
                lifetimeSalesChicagoEl.textContent = chicagoLifetimeSales;
            }
            
            // Display lifetime sales values
            if (lifetimeSalesNyDisplayEl) {
                lifetimeSalesNyDisplayEl.textContent = nyLifetimeSales || '0';
            }
            if (lifetimeSalesChicagoDisplayEl) {
                lifetimeSalesChicagoDisplayEl.textContent = chicagoLifetimeSales || '0';
            }
            
            // Calculate lifetime sales percentages for progress bars
            // Convert text values to numbers for comparison
            const nySalesNum = parseFloat(nyLifetimeSales.toString().replace(/[^0-9.]/g, '')) || 0;
            const chicagoSalesNum = parseFloat(chicagoLifetimeSales.toString().replace(/[^0-9.]/g, '')) || 0;
            const totalSales = nySalesNum + chicagoSalesNum;
            
            const nySalesPercentage = totalSales > 0 ? Math.round((nySalesNum / totalSales) * 100) : 0;
            const chicagoSalesPercentage = totalSales > 0 ? Math.round((chicagoSalesNum / totalSales) * 100) : 0;
            
            // Update lifetime sales percentages
            if (lifetimeSalesNyPercentageEl) {
                lifetimeSalesNyPercentageEl.textContent = nySalesPercentage + '%';
            }
            if (lifetimeSalesChicagoPercentageEl) {
                lifetimeSalesChicagoPercentageEl.textContent = chicagoSalesPercentage + '%';
            }
            
            // Update lifetime sales progress bars
            if (lifetimeSalesNyProgressEl) {
                lifetimeSalesNyProgressEl.style.width = nySalesPercentage + '%';
            }
            if (lifetimeSalesChicagoProgressEl) {
                lifetimeSalesChicagoProgressEl.style.width = chicagoSalesPercentage + '%';
            }
        }
        
        // Show last vote notification
        function showLastVote(choice) {
            const style = choice === 'ny' ? 'New York Style' : 'Chicago Style';
            lastVoteEl.textContent = `New vote for ${style}!`;
            lastVoteEl.classList.add('show');
            
            setTimeout(() => {
                lastVoteEl.classList.remove('show');
            }, 3000);
        }
        
        // Initialize Supabase Realtime subscription for TV display
        if (supabaseClient) {
            try {
                console.log('ðŸ”Œ Setting up Supabase Realtime subscription...');
                const channel = supabaseClient
                    .channel('tv-display-updates', {
                        config: {
                            broadcast: { self: true }
                        }
                    })
                    .on('postgres_changes', {
                        event: '*',
                        schema: 'public',
                        table: 'restaurant_metrics'
                    }, (payload) => {
                        console.log('ðŸ“Š Received Supabase Realtime update:', payload);
                        if (payload.new) {
                            const oldNyVotes = parseInt(nyVotesEl.textContent) || 0;
                            const oldChicagoVotes = parseInt(chicagoVotesEl.textContent) || 0;
                            
                            updateDisplay({
                                nyVotes: payload.new.ny_votes || 0,
                                chicagoVotes: payload.new.chicago_votes || 0,
                                totalVotes: payload.new.total_votes || 0,
                                piesSold: payload.new.pizzas_sold || 0,
                                nyLifetimeSales: payload.new.ny_lifetime_sales || 0,
                                chicagoLifetimeSales: payload.new.chicago_lifetime_sales || 0
                            });
                            
                            // Show notification for new vote
                            if (payload.new.ny_votes > oldNyVotes) {
                                showLastVote('ny');
                            } else if (payload.new.chicago_votes > oldChicagoVotes) {
                                showLastVote('chicago');
                            }
                        }
                    })
                    .subscribe((status, err) => {
                        if (err) {
                            console.error('âŒ Supabase Realtime subscription error:', err);
                            return;
                        }
                        if (status === 'SUBSCRIBED') {
                            console.log('âœ… Supabase Realtime subscription active for TV display');
                        } else if (status === 'CHANNEL_ERROR') {
                            console.error('âŒ Supabase Realtime channel error');
                        } else {
                            console.log('ðŸ”„ Supabase Realtime status:', status);
                        }
                    });
            } catch (error) {
                console.error('âŒ Failed to set up Supabase Realtime:', error);
            }
        } else {
            console.warn('âš ï¸  Supabase client not available - using polling only');
        }
        
        // Polling fallback function (always active as backup)
        function startPolling() {
            console.log('ðŸ”„ Starting polling for TV display updates (backup)');
            setInterval(async () => {
                try {
                    const response = await fetch('/api/voting-data');
                    const data = await response.json();
                    if (data.success) {
                        const currentNyVotes = parseInt(nyVotesEl.textContent) || 0;
                        const currentChicagoVotes = parseInt(chicagoVotesEl.textContent) || 0;
                        
                        // Only update if values changed
                        if (data.data.nyVotes !== currentNyVotes || data.data.chicagoVotes !== currentChicagoVotes) {
                            updateDisplay({
                                nyVotes: data.data.nyVotes || 0,
                                chicagoVotes: data.data.chicagoVotes || 0,
                                totalVotes: data.data.totalVotes || 0,
                                piesSold: data.data.pizzasSold || 0,
                                nyLifetimeSales: data.data.nyLifetimeSales || 0,
                                chicagoLifetimeSales: data.data.chicagoLifetimeSales || 0
                            });
                            
                            // Show notification for new vote
                            if (data.data.nyVotes > currentNyVotes) {
                                showLastVote('ny');
                            } else if (data.data.chicagoVotes > currentChicagoVotes) {
                                showLastVote('chicago');
                            }
                        }
                    }
                } catch (error) {
                    console.error('Error polling TV data:', error);
                }
            }, 5000); // Poll every 5 seconds
        }
        
        // Always start polling as backup (Supabase Realtime is primary)
        startPolling();
        
        // Fullscreen toggle on click
        document.addEventListener('click', () => {
            if (!document.fullscreenElement) {
                document.documentElement.requestFullscreen().catch(err => {
                    console.log('Fullscreen request failed:', err);
                });
            }
        });
        
        // Auto-enter fullscreen on load
        document.addEventListener('DOMContentLoaded', () => {
            setTimeout(() => {
                document.documentElement.requestFullscreen().catch(err => {
                    console.log('Auto-fullscreen failed:', err);
                });
            }, 1000);
        });
    </script>
</body>
</html>

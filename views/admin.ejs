<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title><%= title %></title>
    <meta name="description" content="<%= description %>">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Socket.io Client (optional - only works on non-serverless environments) -->
    <script>
        // Only load Socket.io if we're not on Vercel/serverless
        if (typeof window !== 'undefined' && !window.location.hostname.includes('vercel.app')) {
            const script = document.createElement('script');
            script.src = '/socket.io/socket.io.js';
            script.onerror = function() {
                console.log('Socket.io not available - using polling instead');
            };
            document.head.appendChild(script);
        }
    </script>
    
    <style>
        .admin-container {
            min-height: 100vh;
            background: linear-gradient(135deg, #1a1a1a 0%, #2d1b69 100%);
            color: white;
            font-family: 'Arial', sans-serif;
        }
        
        .admin-card {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border: 2px solid rgba(255, 255, 255, 0.2);
            border-radius: 20px;
            padding: 2rem;
            margin: 1rem 0;
        }
        
        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 60px;
            height: 34px;
        }
        
        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 34px;
        }
        
        .slider:before {
            position: absolute;
            content: "";
            height: 26px;
            width: 26px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        
        input:checked + .slider {
            background-color: #2196F3;
        }
        
        input:checked + .slider:before {
            transform: translateX(26px);
        }
        
        .form-input {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 8px;
            padding: 0.75rem;
            color: white;
            width: 100%;
        }
        
        .form-input:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }
        
        .popup-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }
        
        .popup-content {
            background: #1a1a1a;
            border: 2px solid rgba(255, 255, 255, 0.2);
            border-radius: 20px;
            padding: 2rem;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
            color: white;
        }
        
        .popup-content h3 {
            margin-bottom: 1rem;
            color: #fbbf24;
        }
        
        .popup-content ul {
            list-style: none;
            padding: 0;
        }
        
        .popup-content li {
            padding: 0.5rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .popup-close {
            float: right;
            background: #ef4444;
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 8px;
            cursor: pointer;
            margin-top: 1rem;
        }
        
        .btn-primary {
            background: #3b82f6;
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 10px;
            font-weight: bold;
            transition: all 0.3s ease;
            border: none;
            cursor: pointer;
        }
        
        .btn-primary:hover {
            background: #2563eb;
            transform: scale(1.05);
        }
        
        .btn-success {
            background: #10b981;
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 10px;
            font-weight: bold;
            transition: all 0.3s ease;
            border: none;
            cursor: pointer;
        }
        
        .btn-success:hover {
            background: #059669;
            transform: scale(1.05);
        }
        
        .btn-danger {
            background: #ef4444;
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 10px;
            font-weight: bold;
            transition: all 0.3s ease;
            border: none;
            cursor: pointer;
        }
        
        .btn-danger:hover {
            background: #dc2626;
            transform: scale(1.05);
        }
        
        .btn-warning {
            background: #f59e0b;
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 10px;
            font-weight: bold;
            transition: all 0.3s ease;
            border: none;
            cursor: pointer;
        }
        
        .btn-warning:hover {
            background: #d97706;
            transform: scale(1.05);
        }
        
        .price-input {
            width: 80px;
            text-align: center;
        }
        
        .status-open {
            color: #10b981;
            font-weight: bold;
        }
        
        .status-closed {
            color: #ef4444;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div class="admin-container">
        <div class="max-w-7xl mx-auto px-4 py-8">
            <div class="text-center mb-8">
                <div class="flex justify-between items-center mb-4">
                    <div></div>
                    <div>
                        <h1 class="text-4xl font-bold">üçï That's Amore Admin Panel</h1>
                        <p class="text-xl text-gray-300 mt-2">Complete Restaurant Management System</p>
                    </div>
                    <form method="POST" action="/admin/logout" class="inline">
                        <button type="submit" class="btn-danger text-sm py-2 px-4">
                            üö™ Logout
                        </button>
                    </form>
                </div>
            </div>
            
            <!-- Restaurant Status Control -->
            <div class="admin-card">
                <h2 class="text-2xl font-bold text-green-400 mb-6">üè™ Restaurant Status</h2>
                <div class="grid md:grid-cols-2 gap-6">
                    <div class="flex items-center justify-between p-4 bg-gray-800 rounded-lg">
                        <div>
                            <h3 class="text-lg font-semibold mb-2">Manual Override</h3>
                            <p class="text-sm text-gray-300">Force restaurant to show as closed regardless of hours</p>
                        </div>
                        <label class="toggle-switch">
                            <input type="checkbox" id="manual-closed-toggle">
                            <span class="slider"></span>
                        </label>
                    </div>
                    <div class="p-4 bg-gray-800 rounded-lg">
                        <h3 class="text-lg font-semibold mb-2">Current Status</h3>
                        <p class="text-2xl" id="current-status">Loading...</p>
                    </div>
                </div>
            </div>
            
            <!-- Hours Management -->
            <div class="admin-card">
                <h2 class="text-2xl font-bold text-blue-400 mb-6">üïí Hours Management</h2>
                
                <!-- Daily Business Hours -->
                <div class="mb-6">
                    <h3 class="text-lg font-semibold mb-4">Daily Business Hours</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                        <div id="daily-hours-container">
                            <!-- Daily hours will be populated here -->
                        </div>
                    </div>
                </div>
                
                <div class="mt-4">
                    <button id="save-hours" class="btn-success">üíæ Save All Hours</button>
                </div>
            </div>
            
            <!-- Holiday/Closures -->
            <div class="admin-card">
                <h2 class="text-2xl font-bold text-yellow-400 mb-6">üìÖ Holiday/Closures</h2>
                <div class="mb-6">
                    <h3 class="text-lg font-semibold mb-4">Add Holiday Hours / Closed Date</h3>
                    <div class="grid md:grid-cols-2 gap-4 max-w-2xl">
                        <input type="text" id="holiday-name" class="form-input" placeholder="Holiday Name">
                        <div class="grid grid-cols-2 gap-2">
                            <input type="number" id="holiday-month" class="form-input" placeholder="Month (1-12)" min="1" max="12">
                            <input type="number" id="holiday-day" class="form-input" placeholder="Day (1-31)" min="1" max="31">
                        </div>
                        <input type="text" id="holiday-hours" class="form-input" placeholder="Hours (e.g., 11:00 AM - 3:00 PM or Closed)">
                        <div class="flex items-center space-x-2">
                            <input type="checkbox" id="holiday-open" class="w-4 h-4">
                            <label for="holiday-open" class="text-sm">Open on this holiday</label>
                        </div>
                        <div class="flex items-center space-x-2">
                            <input type="checkbox" id="holiday-repeats-yearly" class="w-4 h-4">
                            <label for="holiday-repeats-yearly" class="text-sm">Repeats yearly</label>
                        </div>
                        <div class="flex items-center space-x-2">
                            <input type="checkbox" id="holiday-calculated" class="w-4 h-4">
                            <label for="holiday-calculated" class="text-sm">Calculated Date</label>
                            <a href="#" id="calculated-dates-link" class="text-blue-400 text-sm underline ml-2" onclick="showCalculatedDatesPopup(event); return false;">(view calculated dates)</a>
                        </div>
                        <button id="add-holiday" class="btn-primary">‚ûï Add Holiday</button>
                    </div>
                </div>
                <div class="mb-6">
                    <h3 class="text-lg font-semibold mb-4">Holidays</h3>
                    <div id="holiday-hours-container" class="space-y-2">
                        <!-- Holiday hours will be populated here -->
                    </div>
                </div>
                <div>
                    <h3 class="text-lg font-semibold mb-4">Upcoming Closures</h3>
                    <div id="closures-list" class="space-y-2">
                        <!-- Closures will be populated here -->
                    </div>
                </div>
            </div>
            
            <!-- TV Page Controls -->
            <div class="admin-card">
                <h2 class="text-2xl font-bold text-red-400 mb-6">üì∫ TV Page Controls</h2>
                <div class="grid md:grid-cols-2 gap-6">
                    <div>
                        <h3 class="text-lg font-semibold mb-4">NY Style Lifetime Sales</h3>
                        <div class="flex items-center space-x-4">
                            <input type="text" id="ny-lifetime-sales" class="form-input price-input" placeholder="e.g., $1,234 or 1,234 pizzas">
                            <button id="update-ny-lifetime-sales" class="btn-primary">Update</button>
                        </div>
                    </div>
                    <div>
                        <h3 class="text-lg font-semibold mb-4">Chicago Style Lifetime Sales</h3>
                        <div class="flex items-center space-x-4">
                            <input type="text" id="chicago-lifetime-sales" class="form-input price-input" placeholder="e.g., $1,234 or 1,234 pizzas">
                            <button id="update-chicago-lifetime-sales" class="btn-primary">Update</button>
                        </div>
                    </div>
                    <div>
                        <h3 class="text-lg font-semibold mb-4">Vote Count Override</h3>
                        <div class="space-y-3">
                            <div class="flex items-center space-x-2">
                                <label class="text-sm">NY Style:</label>
                                <input type="number" id="ny-votes-override" class="form-input price-input" min="0" placeholder="0">
                            </div>
                            <div class="flex items-center space-x-2">
                                <label class="text-sm">Chicago Style:</label>
                                <input type="number" id="chicago-votes-override" class="form-input price-input" min="0" placeholder="0">
                            </div>
                            <button id="update-votes" class="btn-warning">Update Votes</button>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Voting Statistics -->
            <div class="admin-card">
                <h2 class="text-2xl font-bold text-indigo-400 mb-6">üìä Voting Statistics</h2>
                <div class="grid md:grid-cols-2 gap-8">
                    <div class="text-center">
                        <h3 class="text-xl font-bold text-blue-400 mb-4">üóΩ New York Style</h3>
                        <div class="text-4xl font-bold mb-2" id="ny-votes">0</div>
                        <div class="text-lg text-gray-300" id="ny-percentage">0%</div>
                    </div>
                    <div class="text-center">
                        <h3 class="text-xl font-bold text-red-400 mb-4">üèôÔ∏è Chicago Style</h3>
                        <div class="text-4xl font-bold mb-2" id="chicago-votes">0</div>
                        <div class="text-lg text-gray-300" id="chicago-percentage">0%</div>
                    </div>
                </div>
                <div class="text-center mt-6">
                    <div class="text-2xl font-bold mb-2" id="total-votes">0</div>
                    <div class="text-lg text-gray-300">Total Votes Cast</div>
                </div>
                <div class="flex justify-center mt-6 space-x-4">
                    <button id="export-data" class="btn-success">üì• Export Results</button>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        // Connect to WebSocket server (optional - only if available)
        let socket = null;
        if (typeof io !== 'undefined') {
            try {
                socket = io();
            } catch (error) {
                console.warn('Socket.io not available:', error);
            }
        } else {
            console.log('Socket.io not available - using polling for updates');
        }
        
        // DOM elements
        const manualClosedToggle = document.getElementById('manual-closed-toggle');
        const currentStatus = document.getElementById('current-status');
        const saveHoursBtn = document.getElementById('save-hours');
        const holidayName = document.getElementById('holiday-name');
        const holidayMonth = document.getElementById('holiday-month');
        const holidayDay = document.getElementById('holiday-day');
        const holidayHours = document.getElementById('holiday-hours');
        const holidayOpen = document.getElementById('holiday-open');
        const holidayRepeatsYearly = document.getElementById('holiday-repeats-yearly');
        const holidayCalculated = document.getElementById('holiday-calculated');
        const addHolidayBtn = document.getElementById('add-holiday');
        const closuresList = document.getElementById('closures-list');
        const nyLifetimeSales = document.getElementById('ny-lifetime-sales');
        const updateNyLifetimeSalesBtn = document.getElementById('update-ny-lifetime-sales');
        const chicagoLifetimeSales = document.getElementById('chicago-lifetime-sales');
        const updateChicagoLifetimeSalesBtn = document.getElementById('update-chicago-lifetime-sales');
        const nyVotesOverride = document.getElementById('ny-votes-override');
        const chicagoVotesOverride = document.getElementById('chicago-votes-override');
        const updateVotesBtn = document.getElementById('update-votes');
        const nyVotesEl = document.getElementById('ny-votes');
        const chicagoVotesEl = document.getElementById('chicago-votes');
        const nyPercentageEl = document.getElementById('ny-percentage');
        const chicagoPercentageEl = document.getElementById('chicago-percentage');
        const totalVotesEl = document.getElementById('total-votes');
        
        // Load initial data
        loadAdminData();
        
        // Load all admin data
        async function loadAdminData() {
            try {
                const response = await fetch('/api/admin/data');
                const data = await response.json();
                if (data.success) {
                    updateDisplay(data.data);
                    updateRestaurantStatus(data.data.restaurantStatus);
                    updateHoursDisplay(data.data.hours);
                    updateClosuresDisplay(data.data.scheduledClosures);
                    updateTVControls(data.data.tvControls);
                }
            } catch (error) {
                console.error('Error loading admin data:', error);
            }
        }
        
        // Update display with voting data
        function updateDisplay(data) {
            if (data.votingData) {
                nyVotesEl.textContent = data.votingData.nyVotes;
                chicagoVotesEl.textContent = data.votingData.chicagoVotes;
                totalVotesEl.textContent = data.votingData.totalVotes;
                
                const nyPercentage = data.votingData.totalVotes > 0 ? Math.round((data.votingData.nyVotes / data.votingData.totalVotes) * 100) : 0;
                const chicagoPercentage = data.votingData.totalVotes > 0 ? Math.round((data.votingData.chicagoVotes / data.votingData.totalVotes) * 100) : 0;
                
                nyPercentageEl.textContent = nyPercentage + '%';
                chicagoPercentageEl.textContent = chicagoPercentage + '%';
            }
        }
        
        // Update restaurant status display
        function updateRestaurantStatus(status) {
            manualClosedToggle.checked = status.manualClosed || false;
            
            // Display actual current status
            if (status.currentStatus) {
                const statusInfo = status.currentStatus;
                currentStatus.textContent = statusInfo.message || 'Loading...';
                if (statusInfo.isOpen) {
                    currentStatus.className = 'text-2xl status-open';
                } else {
                    currentStatus.className = 'text-2xl status-closed';
                }
            } else {
                // Fallback if currentStatus not available
                if (status.manualClosed) {
                    currentStatus.textContent = 'CLOSED (Manual Override)';
                    currentStatus.className = 'text-2xl status-closed';
                } else {
                    currentStatus.textContent = 'OPEN (Based on Hours)';
                    currentStatus.className = 'text-2xl status-open';
                }
            }
        }
        
        // Update hours display
        function updateHoursDisplay(hours) {
            updateDailyHoursDisplay(hours.businessHours || []);
            updateHolidayHoursDisplay(hours.holidayHours || []);
        }
        
        // Update daily hours display
        function updateDailyHoursDisplay(businessHours) {
            const container = document.getElementById('daily-hours-container');
            container.innerHTML = '';
            
            const days = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
            
            days.forEach((day, index) => {
                const dayData = businessHours[index] || { day, hours: 'Closed', open: false };
                const dayDiv = document.createElement('div');
                dayDiv.className = 'p-4 bg-gray-800 rounded-lg';
                dayDiv.innerHTML = `
                    <h4 class="font-semibold text-accent mb-2">${day}</h4>
                    <div class="space-y-2">
                        <div class="flex items-center space-x-2">
                            <input type="checkbox" id="open-${index}" ${dayData.open ? 'checked' : ''} class="w-4 h-4">
                            <label for="open-${index}" class="text-sm">Open</label>
                        </div>
                        <input type="text" id="hours-${index}" value="${dayData.hours}" 
                               class="form-input text-sm" placeholder="e.g., 11:00 AM - 8:00 PM">
                    </div>
                `;
                container.appendChild(dayDiv);
            });
        }
        
        // Update holiday hours display
        function updateHolidayHoursDisplay(holidayHours) {
            const container = document.getElementById('holiday-hours-container');
            container.innerHTML = '';
            
            holidayHours.forEach((holiday, index) => {
                const holidayDiv = document.createElement('div');
                holidayDiv.className = 'p-4 bg-gray-800 rounded-lg mb-3';
                holidayDiv.innerHTML = `
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-3">
                        <input type="text" value="${holiday.name}" placeholder="Holiday Name" 
                               class="form-input text-sm" data-field="name" data-index="${index}">
                        <input type="number" value="${holiday.month}" placeholder="Month (1-12)" min="1" max="12"
                               class="form-input text-sm" data-field="month" data-index="${index}">
                        <input type="number" value="${holiday.day}" placeholder="Day (1-31)" min="1" max="31"
                               class="form-input text-sm" data-field="day" data-index="${index}">
                        <div class="flex items-center space-x-2">
                            <input type="text" value="${holiday.hours}" placeholder="Hours" 
                                   class="form-input text-sm" data-field="hours" data-index="${index}">
                            <input type="checkbox" ${holiday.open ? 'checked' : ''} 
                                   class="w-4 h-4" data-field="open" data-index="${index}">
                            <label class="text-sm">Open</label>
                        </div>
                    </div>
                    <div class="flex justify-between items-center mt-3">
                        <div class="flex items-center space-x-2">
                            <input type="checkbox" ${holiday.isCalculated ? 'checked' : ''} 
                                   class="w-4 h-4" data-field="isCalculated" data-index="${index}">
                            <label class="text-sm">Calculated Date (Easter/Thanksgiving)</label>
                        </div>
                        <button class="btn-danger text-sm" onclick="deleteHoliday(${index})">üóëÔ∏è</button>
                    </div>
                `;
                container.appendChild(holidayDiv);
            });
        }
        
        // Update closures display
        function updateClosuresDisplay(closures) {
            closuresList.innerHTML = '';
            closures.forEach(closure => {
                const closureDiv = document.createElement('div');
                closureDiv.className = 'flex justify-between items-center p-3 bg-gray-800 rounded-lg';
                closureDiv.innerHTML = `
                    <div>
                        <span class="font-semibold">${new Date(closure.date).toLocaleDateString()}</span>
                        ${closure.reason ? `<span class="text-gray-300 ml-2">- ${closure.reason}</span>` : ''}
                    </div>
                    <button class="btn-danger text-sm" onclick="deleteClosure('${closure.date}')">üóëÔ∏è</button>
                `;
                closuresList.appendChild(closureDiv);
            });
        }
        
        // Update TV controls display
        function updateTVControls(controls) {
            if (nyLifetimeSales) nyLifetimeSales.value = controls.nyLifetimeSales || '';
            if (chicagoLifetimeSales) chicagoLifetimeSales.value = controls.chicagoLifetimeSales || '';
            nyVotesOverride.value = controls.nyVotes || 0;
            chicagoVotesOverride.value = controls.chicagoVotes || 0;
        }
        
        // Event Listeners
        manualClosedToggle.addEventListener('change', async () => {
            try {
                const response = await fetch('/api/admin/restaurant-status', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ manualClosed: manualClosedToggle.checked })
                });
                
                const result = await response.json();
                if (result.success) {
                    updateRestaurantStatus(result.data);
                }
            } catch (error) {
                console.error('Error updating restaurant status:', error);
            }
        });
        
        saveHoursBtn.addEventListener('click', async () => {
            try {
                // Collect daily business hours
                const businessHours = [];
                for (let i = 0; i < 7; i++) {
                    const openCheckbox = document.getElementById(`open-${i}`);
                    const hoursInput = document.getElementById(`hours-${i}`);
                    businessHours.push({
                        day: ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'][i],
                        hours: hoursInput.value,
                        open: openCheckbox.checked
                    });
                }
                
                // Collect holiday hours
                const holidayHours = [];
                const holidayContainers = document.querySelectorAll('#holiday-hours-container > div');
                holidayContainers.forEach(container => {
                    const inputs = container.querySelectorAll('input[data-field]');
                    const holiday = {};
                    inputs.forEach(input => {
                        const field = input.dataset.field;
                        if (input.type === 'checkbox') {
                            holiday[field] = input.checked;
                        } else {
                            holiday[field] = field === 'month' || field === 'day' ? parseInt(input.value) : input.value;
                        }
                    });
                    // Set defaults for optional fields
                    if (!holiday.hasOwnProperty('repeatsYearly')) holiday.repeatsYearly = true; // Default to true
                    if (holiday.name && holiday.month && holiday.day && holiday.hours !== undefined) {
                        holidayHours.push(holiday);
                    }
                });
                
                const response = await fetch('/api/admin/hours', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        businessHours,
                        holidayHours
                    })
                });
                
                const result = await response.json();
                if (result.success) {
                    alert('Hours saved successfully!');
                }
            } catch (error) {
                console.error('Error saving hours:', error);
            }
        });
        
        addHolidayBtn.addEventListener('click', () => {
            if (!holidayName.value || !holidayMonth.value || !holidayDay.value || !holidayHours.value) {
                alert('Please fill in all holiday fields');
                return;
            }
            
            // Get current holidays
            const container = document.getElementById('holiday-hours-container');
            const currentHolidays = Array.from(container.children).map((div, index) => {
                const inputs = div.querySelectorAll('input[data-field]');
                const holiday = {};
                inputs.forEach(input => {
                    const field = input.dataset.field;
                    if (input.type === 'checkbox') {
                        holiday[field] = input.checked;
                    } else {
                        holiday[field] = field === 'month' || field === 'day' ? parseInt(input.value) : input.value;
                    }
                });
                return holiday;
            });
            
            // Add new holiday
            const newHoliday = {
                name: holidayName.value,
                month: parseInt(holidayMonth.value),
                day: parseInt(holidayDay.value),
                hours: holidayHours.value,
                open: holidayOpen.checked,
                isCalculated: holidayCalculated.checked,
                repeatsYearly: holidayRepeatsYearly.checked
            };
            
            currentHolidays.push(newHoliday);
            updateHolidayHoursDisplay(currentHolidays);
            
            // Clear form
            holidayName.value = '';
            holidayMonth.value = '';
            holidayDay.value = '';
            holidayHours.value = '';
            holidayOpen.checked = false;
            holidayCalculated.checked = false;
            holidayRepeatsYearly.checked = false;
        });
        
        updateNyLifetimeSalesBtn.addEventListener('click', async () => {
            try {
                const response = await fetch('/api/admin/tv-controls', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ nyLifetimeSales: nyLifetimeSales.value || '' })
                });
                
                const result = await response.json();
                if (result.success) {
                    alert('NY Style lifetime sales updated successfully!');
                }
            } catch (error) {
                console.error('Error updating NY lifetime sales:', error);
            }
        });
        
        updateChicagoLifetimeSalesBtn.addEventListener('click', async () => {
            try {
                const response = await fetch('/api/admin/tv-controls', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ chicagoLifetimeSales: chicagoLifetimeSales.value || '' })
                });
                
                const result = await response.json();
                if (result.success) {
                    alert('Chicago Style lifetime sales updated successfully!');
                }
            } catch (error) {
                console.error('Error updating Chicago lifetime sales:', error);
            }
        });
        
        updateVotesBtn.addEventListener('click', async () => {
            try {
                const response = await fetch('/api/admin/tv-controls', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        nyVotes: parseInt(nyVotesOverride.value) || 0,
                        chicagoVotes: parseInt(chicagoVotesOverride.value) || 0
                    })
                });
                
                const result = await response.json();
                if (result.success) {
                    alert('Vote counts updated successfully!');
                    updateDisplay(result.data);
                }
            } catch (error) {
                console.error('Error updating votes:', error);
            }
        });
        
        // Socket event handlers (only if socket is available)
        if (socket) {
            socket.on('connect', () => {
                console.log('Connected to server');
            });
            
            socket.on('disconnect', () => {
                console.log('Disconnected from server');
            });
            
            socket.on('voting-update', (data) => {
                updateDisplay({ votingData: data });
            });
        } else {
            // Polling fallback when Socket.io not available
            console.log('Using polling for updates (Socket.io not available)');
            setInterval(async () => {
                try {
                    const response = await fetch('/api/admin/data');
                    const result = await response.json();
                    if (result.success) {
                        updateDisplay(result.data);
                    }
                } catch (error) {
                    console.error('Error polling admin data:', error);
                }
            }, 10000); // Poll every 10 seconds
        }
        
        // Admin actions
        document.getElementById('reset-votes').addEventListener('click', async () => {
            if (confirm('Are you sure you want to reset all votes? This action cannot be undone.')) {
                try {
                    const response = await fetch('/api/admin/reset-votes', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' }
                    });
                    
                    const result = await response.json();
                    if (result.success) {
                        alert('Votes reset successfully!');
                        updateDisplay({ votingData: result.data });
                    } else {
                        alert('Error resetting votes: ' + result.message);
                    }
                } catch (error) {
                    console.error('Error resetting votes:', error);
                    alert('Error resetting votes. Please try again.');
                }
            }
        });
        
        document.getElementById('export-data').addEventListener('click', () => {
            const data = {
                nyVotes: parseInt(nyVotesEl.textContent),
                chicagoVotes: parseInt(chicagoVotesEl.textContent),
                totalVotes: parseInt(totalVotesEl.textContent),
                timestamp: new Date().toISOString()
            };
            
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `pizza-voting-results-${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            alert('Voting results exported successfully!');
        });
        
        // Global functions for delete operations
        window.deleteClosure = async function(date) {
            if (confirm('Are you sure you want to delete this closure?')) {
                try {
                    const response = await fetch(`/api/admin/closures/${date}`, {
                        method: 'DELETE'
                    });
                    
                    const result = await response.json();
                    if (result.success) {
                        updateClosuresDisplay(result.data);
                        alert('Closure deleted successfully!');
                    }
                } catch (error) {
                    console.error('Error deleting closure:', error);
                }
            }
        };
        
        window.deleteHoliday = function(index) {
            if (confirm('Are you sure you want to delete this holiday?')) {
                const container = document.getElementById('holiday-hours-container');
                const holidayDiv = container.children[index];
                if (holidayDiv) {
                    holidayDiv.remove();
                }
            }
        };
        
        // Show calculated dates popup
        window.showCalculatedDatesPopup = function(event) {
            event.preventDefault();
            
            const calculatedDates = [
                { name: 'Easter', description: 'First Sunday after the first full moon following the March equinox' },
                { name: 'Thanksgiving', description: 'Fourth Thursday of November' },
                { name: 'Good Friday', description: 'Friday before Easter Sunday' },
                { name: 'Easter Monday', description: 'Monday after Easter Sunday' },
                { name: 'Memorial Day', description: 'Last Monday of May' },
                { name: 'Labor Day', description: 'First Monday of September' },
                { name: 'Columbus Day', description: 'Second Monday of October' },
                { name: 'Presidents Day', description: 'Third Monday of February' },
                { name: 'Martin Luther King Jr. Day', description: 'Third Monday of January' }
            ];
            
            const popup = document.createElement('div');
            popup.className = 'popup-overlay';
            popup.innerHTML = `
                <div class="popup-content">
                    <h3>Calculated Dates Reference</h3>
                    <p class="text-gray-400 mb-4">These dates are calculated automatically each year:</p>
                    <ul>
                        ${calculatedDates.map(date => `
                            <li>
                                <strong class="text-yellow-400">${date.name}:</strong>
                                <span class="text-gray-300">${date.description}</span>
                            </li>
                        `).join('')}
                    </ul>
                    <button class="popup-close" onclick="this.closest('.popup-overlay').remove()">Close</button>
                </div>
            `;
            
            document.body.appendChild(popup);
            
            // Close on overlay click
            popup.addEventListener('click', (e) => {
                if (e.target === popup) {
                    popup.remove();
                }
            });
        };
    </script>
</body>
</html>

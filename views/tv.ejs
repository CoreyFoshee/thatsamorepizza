<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title><%= title %></title>
    <meta name="description" content="<%= description %>">
    <meta name="robots" content="noindex, nofollow">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Supabase Client for Real-time Updates -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        // Expose Supabase credentials to frontend (anon key is safe for public use)
        window.supabaseUrl = '<%= typeof supabaseUrl !== "undefined" ? supabaseUrl : "" %>';
        window.supabaseAnonKey = '<%= typeof supabaseAnonKey !== "undefined" ? supabaseAnonKey : "" %>';
        // Store reference to the global supabase object
        window.supabaseLib = supabase;
    </script>
    
    <!-- Custom Styles -->
    <style>
        body {
            margin: 0;
            padding: 0;
            overflow: hidden;
            background: linear-gradient(135deg, #1a1a1a 0%, #2d1b69 100%);
        }
        
        .tv-container {
            width: 100vw;
            height: 100vh;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            color: white;
            font-family: 'Arial', sans-serif;
        }
        
        .voting-results {
            text-align: center;
            max-width: 95vw;
        }
        
        .pizza-style {
            margin: 1rem 0;
            padding: 2rem;
            border-radius: 20px;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border: 2px solid rgba(255, 255, 255, 0.2);
        }
        
        .qr-section {
            flex-shrink: 0;
        }
        
        .progress-bar {
            width: 100%;
            height: 40px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 20px;
            overflow: hidden;
            margin: 1rem 0;
        }
        
        .progress-fill {
            height: 100%;
            transition: width 0.8s ease-in-out;
            border-radius: 20px;
        }
        
        .ny-progress {
            background: linear-gradient(90deg, #3b82f6, #1d4ed8);
        }
        
        .chicago-progress {
            background: linear-gradient(90deg, #dc2626, #991b1b);
        }
        
        .vote-count {
            font-size: 4rem;
            font-weight: bold;
            margin: 1rem 0;
        }
        
        .percentage {
            font-size: 2rem;
            font-weight: bold;
            margin: 1rem 0;
        }
        
        .total-votes {
            font-size: 1.5rem;
            margin: 2rem 0;
            color: #fbbf24;
        }
        
        .title {
            font-size: 3rem;
            font-weight: bold;
            margin-bottom: 2rem;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
        }
        
        .subtitle {
            font-size: 1.5rem;
            margin-bottom: 3rem;
            color: #fbbf24;
        }
        
        .live-indicator {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #ef4444;
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 25px;
            font-weight: bold;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        .last-vote {
            position: fixed;
            bottom: 20px;
            left: 20px;
            background: rgba(34, 197, 94, 0.9);
            color: white;
            padding: 1rem;
            border-radius: 10px;
            font-weight: bold;
            transform: translateX(-100%);
            transition: transform 0.5s ease-in-out;
        }
        
        .last-vote.show {
            transform: translateX(0);
        }
        
        @media (max-width: 768px) {
            .title { font-size: 2rem; }
            .vote-count { font-size: 2.5rem; }
            .percentage { font-size: 1.5rem; }
            .pizza-style { margin: 1rem 0; padding: 1rem; }
            .flex-col.lg\:flex-row { gap: 2rem; }
            .qr-section { order: -1; margin-bottom: 1rem; }
        }
    </style>
</head>
<body>
    <div class="live-indicator">üî¥ LIVE</div>
    
    <div class="tv-container">
        <div class="voting-results">
            <h1 class="title">üçï The Great Pizza Debate</h1>
            <p class="subtitle">Voting Updates Daily</p>
            
            <div class="flex flex-col lg:flex-row gap-8 items-center justify-center">
                <!-- NY Style - Left Side -->
                <div class="pizza-style flex-1 max-w-md">
                    <h2 class="text-3xl font-bold text-blue-400 mb-4">New York Style</h2>
                    <div class="vote-count" id="ny-votes">0</div>
                    <div class="percentage" id="ny-percentage">0%</div>
                    <div class="progress-bar">
                        <div class="progress-fill ny-progress" id="ny-progress" style="width: 0%"></div>
                    </div>
                </div>
                
                <!-- Center Section with QR Code and Pies Sold -->
                <div class="qr-section text-center">
                    <div class="bg-white rounded-2xl p-6 shadow-lg mb-6">
                        <div class="text-6xl mb-4">üì±</div>
                        <h3 class="text-xl font-bold text-gray-800 mb-2">Scan QR Code To Vote!</h3>
                        <p class="text-sm text-gray-600 mb-4">Help us settle the great pizza debate.</p>
                        <div class="w-32 h-32 mx-auto flex items-center justify-center">
                            <img src="/images/qr-code.svg" alt="QR Code to vote" class="w-full h-full object-contain" />
                        </div>
                        <p class="text-xs text-gray-500 mt-2">thatsamorepizzaonline.com</p>
                    </div>
                    
                    <!-- Pies Sold Counter -->
                    <div class="bg-gradient-to-br from-yellow-400 to-orange-500 rounded-2xl p-6 shadow-lg">
                        <div class="text-4xl mb-2">üçï</div>
                        <h3 class="text-xl font-bold text-white mb-2">Pies Sold Today</h3>
                        <div class="text-3xl font-bold text-white" id="pies-sold">0</div>
                    </div>
                </div>
                
                <!-- Chicago Style - Right Side -->
                <div class="pizza-style flex-1 max-w-md">
                    <h2 class="text-3xl font-bold text-red-400 mb-4">Chicago Style</h2>
                    <div class="vote-count" id="chicago-votes">0</div>
                    <div class="percentage" id="chicago-percentage">0%</div>
                    <div class="progress-bar">
                        <div class="progress-fill chicago-progress" id="chicago-progress" style="width: 0%"></div>
                    </div>
                </div>
            </div>
            
            <div class="total-votes">
                Total Votes: <span id="total-votes">0</span>
            </div>
        </div>
    </div>
    
    <div class="last-vote" id="last-vote">
        New vote received!
    </div>
    
    <script>
        // Initialize Supabase client
        let supabaseClient = null;
        if (window.supabaseLib && window.supabaseUrl && window.supabaseAnonKey) {
            try {
                supabaseClient = window.supabaseLib.createClient(window.supabaseUrl, window.supabaseAnonKey);
                console.log('‚úÖ Supabase client initialized for TV display');
            } catch (error) {
                console.error('‚ùå Failed to initialize Supabase client:', error);
            }
        } else {
            console.error('‚ùå Supabase credentials not available', {
                hasLib: !!window.supabaseLib,
                hasUrl: !!window.supabaseUrl,
                hasKey: !!window.supabaseAnonKey
            });
        }
        
        // DOM elements
        const nyVotesEl = document.getElementById('ny-votes');
        const chicagoVotesEl = document.getElementById('chicago-votes');
        const nyPercentageEl = document.getElementById('ny-percentage');
        const chicagoPercentageEl = document.getElementById('chicago-percentage');
        const nyProgressEl = document.getElementById('ny-progress');
        const chicagoProgressEl = document.getElementById('chicago-progress');
        const totalVotesEl = document.getElementById('total-votes');
        const lastVoteEl = document.getElementById('last-vote');
        const piesSoldEl = document.getElementById('pies-sold');
        
        // Load initial data from Supabase
        loadInitialData();
        
        // Load data from Supabase via API
        async function loadInitialData() {
            try {
                // Try to load from restaurant_metrics table via API
                const response = await fetch('/api/voting-data');
                const data = await response.json();
                if (data.success) {
                    console.log('Loaded initial data from Supabase:', data.data);
                    updateDisplay({
                        nyVotes: data.data.nyVotes || 0,
                        chicagoVotes: data.data.chicagoVotes || 0,
                        totalVotes: data.data.totalVotes || 0,
                        piesSold: data.data.pizzasSold || 0
                    });
                } else {
                    console.error('Failed to load data:', data);
                }
            } catch (error) {
                console.error('Error loading data from Supabase:', error);
            }
        }
        
        // Update display with voting data
        function updateDisplay(data) {
            nyVotesEl.textContent = data.nyVotes || 0;
            chicagoVotesEl.textContent = data.chicagoVotes || 0;
            totalVotesEl.textContent = data.totalVotes || 0;
            piesSoldEl.textContent = data.piesSold || data.pizzasSold || 0;
            
            // Calculate percentages
            const nyPercentage = data.totalVotes > 0 ? Math.round((data.nyVotes / data.totalVotes) * 100) : 0;
            const chicagoPercentage = data.totalVotes > 0 ? Math.round((data.chicagoVotes / data.totalVotes) * 100) : 0;
            
            nyPercentageEl.textContent = nyPercentage + '%';
            chicagoPercentageEl.textContent = chicagoPercentage + '%';
            
            // Update progress bars
            nyProgressEl.style.width = nyPercentage + '%';
            chicagoProgressEl.style.width = chicagoPercentage + '%';
        }
        
        // Show last vote notification
        function showLastVote(choice) {
            const style = choice === 'ny' ? 'New York Style' : 'Chicago Style';
            lastVoteEl.textContent = `New vote for ${style}!`;
            lastVoteEl.classList.add('show');
            
            setTimeout(() => {
                lastVoteEl.classList.remove('show');
            }, 3000);
        }
        
        // Initialize Supabase Realtime subscription for TV display
        if (supabaseClient) {
            try {
                console.log('üîå Setting up Supabase Realtime subscription...');
                const channel = supabaseClient
                    .channel('tv-display-updates', {
                        config: {
                            broadcast: { self: true }
                        }
                    })
                    .on('postgres_changes', {
                        event: '*',
                        schema: 'public',
                        table: 'restaurant_metrics'
                    }, (payload) => {
                        console.log('üìä Received Supabase Realtime update:', payload);
                        if (payload.new) {
                            const oldNyVotes = parseInt(nyVotesEl.textContent) || 0;
                            const oldChicagoVotes = parseInt(chicagoVotesEl.textContent) || 0;
                            
                            updateDisplay({
                                nyVotes: payload.new.ny_votes || 0,
                                chicagoVotes: payload.new.chicago_votes || 0,
                                totalVotes: payload.new.total_votes || 0,
                                piesSold: payload.new.pizzas_sold || 0
                            });
                            
                            // Show notification for new vote
                            if (payload.new.ny_votes > oldNyVotes) {
                                showLastVote('ny');
                            } else if (payload.new.chicago_votes > oldChicagoVotes) {
                                showLastVote('chicago');
                            }
                        }
                    })
                    .subscribe((status, err) => {
                        if (err) {
                            console.error('‚ùå Supabase Realtime subscription error:', err);
                            return;
                        }
                        if (status === 'SUBSCRIBED') {
                            console.log('‚úÖ Supabase Realtime subscription active for TV display');
                        } else if (status === 'CHANNEL_ERROR') {
                            console.error('‚ùå Supabase Realtime channel error');
                        } else {
                            console.log('üîÑ Supabase Realtime status:', status);
                        }
                    });
            } catch (error) {
                console.error('‚ùå Failed to set up Supabase Realtime:', error);
            }
        } else {
            console.warn('‚ö†Ô∏è  Supabase client not available - using polling only');
        }
        
        // Polling fallback function (always active as backup)
        function startPolling() {
            console.log('üîÑ Starting polling for TV display updates (backup)');
            setInterval(async () => {
                try {
                    const response = await fetch('/api/voting-data');
                    const data = await response.json();
                    if (data.success) {
                        const currentNyVotes = parseInt(nyVotesEl.textContent) || 0;
                        const currentChicagoVotes = parseInt(chicagoVotesEl.textContent) || 0;
                        
                        // Only update if values changed
                        if (data.data.nyVotes !== currentNyVotes || data.data.chicagoVotes !== currentChicagoVotes) {
                            updateDisplay({
                                nyVotes: data.data.nyVotes || 0,
                                chicagoVotes: data.data.chicagoVotes || 0,
                                totalVotes: data.data.totalVotes || 0,
                                piesSold: data.data.pizzasSold || 0
                            });
                            
                            // Show notification for new vote
                            if (data.data.nyVotes > currentNyVotes) {
                                showLastVote('ny');
                            } else if (data.data.chicagoVotes > currentChicagoVotes) {
                                showLastVote('chicago');
                            }
                        }
                    }
                } catch (error) {
                    console.error('Error polling TV data:', error);
                }
            }, 5000); // Poll every 5 seconds
        }
        
        // Always start polling as backup (Supabase Realtime is primary)
        startPolling();
        
        // Fullscreen toggle on click
        document.addEventListener('click', () => {
            if (!document.fullscreenElement) {
                document.documentElement.requestFullscreen().catch(err => {
                    console.log('Fullscreen request failed:', err);
                });
            }
        });
        
        // Auto-enter fullscreen on load
        document.addEventListener('DOMContentLoaded', () => {
            setTimeout(() => {
                document.documentElement.requestFullscreen().catch(err => {
                    console.log('Auto-fullscreen failed:', err);
                });
            }, 1000);
        });
    </script>
</body>
</html>
